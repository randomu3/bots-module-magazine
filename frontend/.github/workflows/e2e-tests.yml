name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build application
      run: |
        cd frontend
        npm run build
        
    - name: Start application
      run: |
        cd frontend
        npm start &
        sleep 30
        
    - name: Run E2E tests
      uses: cypress-io/github-action@v6
      with:
        working-directory: frontend
        browser: ${{ matrix.browser }}
        wait-on: 'http://localhost:3000'
        wait-on-timeout: 120
        
    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: cypress-screenshots-${{ matrix.browser }}
        path: frontend/cypress/screenshots
        
    - name: Upload videos
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cypress-videos-${{ matrix.browser }}
        path: frontend/cypress/videos

  mobile-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build application
      run: |
        cd frontend
        npm run build
        
    - name: Start application
      run: |
        cd frontend
        npm start &
        sleep 30
        
    - name: Run Mobile E2E tests
      uses: cypress-io/github-action@v6
      with:
        working-directory: frontend
        browser: chrome
        wait-on: 'http://localhost:3000'
        wait-on-timeout: 120
        spec: cypress/e2e/responsive/**/*.cy.ts
        config: viewportWidth=375,viewportHeight=667
        
    - name: Upload mobile test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cypress-mobile-artifacts
        path: |
          frontend/cypress/screenshots
          frontend/cypress/videos

  critical-path-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Build application
      run: |
        cd frontend
        npm run build
        
    - name: Start application
      run: |
        cd frontend
        npm start &
        sleep 30
        
    - name: Run Critical Path tests
      uses: cypress-io/github-action@v6
      with:
        working-directory: frontend
        browser: chrome
        wait-on: 'http://localhost:3000'
        wait-on-timeout: 120
        spec: cypress/e2e/critical-paths/**/*.cy.ts
        
    - name: Upload critical path test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cypress-critical-path-artifacts
        path: |
          frontend/cypress/screenshots
          frontend/cypress/videos